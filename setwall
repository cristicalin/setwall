#!/usr/bin/python

import sys
import atexit
import argparse

import dbus
import dbus.service
import dbus.glib

from urllib2 import quote, unquote
from apscheduler.scheduler import Scheduler
from gi.repository import Gio as gio
from gi.repository import Gtk as gtk
from gi.repository import GObject as gobject
from gi.repository import AppIndicator3 as appindicator
from gi.repository import Notify as notify

# Local imports
from globals import *
from settings import *
from filelist import *

# Global variables, dirty hack
sched = None
my_settings = None
play_icon = None
stop_icon = None
file_list = None
toggle_menu = None

# allow other threads to execute
dbus.glib.init_threads()
gobject.threads_init()

# This handles setting the wallpaper on the Gnome desktop
# and returning the name of the current wallpaper file
# This assumes that the current wallpaper is set
# if picture-uri in gsettings is null this will return None
class setwall:

  def __init__(self):
    self.notification = notify.Notification.new("", "", None)
 
  def get_wallpaper(self):
    try:
      global my_settings
      old_wallpaper = my_settings.get_wallpaper()
      tmp = old_wallpaper.split("/")
      return unquote(tmp[len(tmp)-1])
    except:
      return None

  def set_wallpaper(self, filename):
    global my_settings
    old_wallpaper = self.get_wallpaper()
    new_file = filename.split("/")
    new_wallpaper = "file://%s" % quote(filename)
    my_settings.set_wallpaper(new_wallpaper)
    self.notification.update(
      "Wallpaper changed",
      "<b>Old:</b> %s<br/><b>New:</b> %s" 
      % (old_wallpaper, new_file[len(new_file)-1]),
      None
    )
    self.notification.show()

# This is a handler class for the DBus messages, it allows
# the application to receive next and previous messages
class handledbus(dbus.service.Object):

  @dbus.service.method("%s.%s" % (BASE_ID, APP_NAME),
                       in_signature='', out_signature='')
  def next(self):
    next_wallpaper()

  @dbus.service.method("%s.%s" % (BASE_ID, APP_NAME),
                       in_signature='', out_signature='')
  def previous(self):
    previous_wallpaper()

  @dbus.service.method("%s.%s" % (BASE_ID, APP_NAME),
                       in_signature='', out_signature='')
  def toggle(self):
    global toggle_menu
    toggle_schedule(toggle_menu)
    
  @dbus.service.method("%s.%s" % (BASE_ID, APP_NAME),
                       in_signature='', out_signature='')
  def quit(self):
    quit_app()
    
# Global functions start here
def quit_app(item = None):
  # we neet to stop both the notifier as well as the gtk main loop
  global file_list
  file_list.close()
  gtk.main_quit()

def next_wallpaper(item = None):
  global file_list
  wp.set_wallpaper(file_list.get_next_file())

def previous_wallpaper(item = None):
  global file_list
  wp.set_wallpaper(file_list.get_previous_file())

def toggle_schedule(item = None):
  global my_settings
  if my_settings.get_wallpaper_schedule():
    sched.unschedule_func(next_wallpaper)
    item.set_image(play_icon)
    item.set_label(TEXT_CONTINUE)
  else:
    sched.add_interval_job(next_wallpaper, seconds=my_settings.get_wallpaper_interval())
    item.set_image(stop_icon)
    item.set_label(TEXT_PAUSE)
  my_settings.set_wallpaper_schedule(not my_settings.get_wallpaper_schedule())

def show_settings(item = None):
  my_settings.show_window()

# Build the application menu which is delivered
# via the appindicator functionality
def get_app_menu():
  global my_settings
  load_icons()
  menu = gtk.Menu()
   
  next_menu = gtk.MenuItem()
  next_menu.set_label("Next Wallpaper")
  next_menu.connect("activate", next_wallpaper)
  menu.append(next_menu)

  prev_menu = gtk.MenuItem()
  prev_menu.set_label("Previous Wallpaper")
  prev_menu.connect("activate", previous_wallpaper)
  menu.append(prev_menu)

  options_menu_item = gtk.MenuItem()
  options_menu_item.set_label("Scaling Options");
  menu.append(options_menu_item)
  options_menu = gtk.Menu()

  options_range = my_settings.get_wallpaper_options_range()
  for option in options_range[1]:
    menu_option = gtk.MenuItem(option.title())
    menu_option.connect("activate", 
      lambda item, data: my_settings.set_wallpaper_options(data), option)
    options_menu.append(menu_option)
  options_menu_item.set_submenu(options_menu)

  toggle_text = TEXT_CONTINUE
  toggle_icon = play_icon
  if my_settings.get_wallpaper_schedule():
    toggle_text = TEXT_PAUSE
    toggle_icon = stop_icon
  global toggle_menu
  toggle_menu = gtk.ImageMenuItem()
  toggle_menu.connect("activate", toggle_schedule)
  toggle_menu.set_always_show_image(True)
  toggle_menu.set_image(toggle_icon)
  toggle_menu.set_label(toggle_text)
  menu.append(toggle_menu)

  menu.append(gtk.SeparatorMenuItem())

  settings_menu = gtk.MenuItem("Settings")
  settings_menu.connect("activate", show_settings)
  menu.append(settings_menu)

  quit_menu = gtk.MenuItem("Quit")
  quit_menu.connect("activate", quit_app)
  menu.append(quit_menu)

  menu.show_all()
  return menu

# Keep icons stored in memory so we don't have to
# reload them each time the menu is toggled
def load_icons():
  global play_icon
  play_icon = gtk.Image()
  play_icon.set_from_icon_name(gtk.STOCK_MEDIA_PLAY, gtk.IconSize.MENU)
  play_icon.show()
  global stop_icon 
  stop_icon = gtk.Image()
  stop_icon.set_from_icon_name(gtk.STOCK_MEDIA_STOP, gtk.IconSize.MENU)
  stop_icon.show()

# Main application body
if __name__ == "__main__":
  # Parse the command line arguments
  parser = argparse.ArgumentParser("Wallpaper Changer")
  parser.add_argument("-p", "--path", type=str,
                      help="Path in which wallpapers reside")
  parser.add_argument("-i", "--interval", type=int,
                      help="Time interval in seconds between switches")
  parser.add_argument("-s", "--schedule", type=bool,
                      help="Scheduled wallpaper changes")
  args = parser.parse_args()
  my_settings = settings(args)
   
  app = appindicator.Indicator.new(
    APP_NAME.replace("_","-"), "preferences-desktop-wallpaper",
    appindicator.IndicatorCategory.APPLICATION_STATUS
  )
  app.set_status(appindicator.IndicatorStatus.ACTIVE)
  notify.init(APP_NAME)

  app.set_menu(get_app_menu())

  # build the file list and create the wallpaper change object
  file_list = filelist(my_settings.get_wallpaper_path())
  wp = setwall()
  file_list.set_index(wp.get_wallpaper())

  # Schedule periodic changes of the firewall
  # we only start a job here if the we need to, user might want
  # to start with this setting disabled
  sched = Scheduler()
  sched.start()
  if my_settings.get_wallpaper_schedule():
    sched.add_interval_job(next_wallpaper,
                           seconds=my_settings.get_wallpaper_interval())

  # make sure we properly clean up after ourselves 
  atexit.register(lambda: sched.shutdown(wait=True))

  # initialize DBus
  session_bus = dbus.SessionBus()
  session_name = dbus.service.BusName("%s.%s" % (BASE_ID, APP_NAME), session_bus)
  session_object = handledbus(session_bus, "%s/%s" % (APP_PATH, APP_NAME))

  gtk.main()

  sys.exit(0)
